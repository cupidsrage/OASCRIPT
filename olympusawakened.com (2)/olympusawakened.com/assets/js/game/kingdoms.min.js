'use strict';
(function initKingdomStatusPolling() {
    const FAST_INTERVAL_MS = 1000;
    const SLOW_INTERVAL_MS = 5000;
    const HIDDEN_INTERVAL_MS = 15000;
    let pollTimer = null;
    let currentInterval = 0;
    let pollingSuspended = !1;
    let visibilityIntervalOverride = 0;

    function isPageVisible() {
        return typeof document.visibilityState === 'undefined' || document.visibilityState !== 'hidden'
    }

    function getPanel() {
        return document.querySelector('[data-kingdom-panel]')
    }

    function applySnapshot(kingdom) {
        if (!kingdom) {
            return
        }
        const root = getPanel();
        if (!root) {
            return
        }
        const formatInt = (window.App && typeof window.App.formatInt === 'function') ? window.App.formatInt : (value) => {
            const n = typeof value === 'number' && Number.isFinite(value) ? value : Number(value) || 0;
            return String(n)
        };

        function updateText(statKey, text) {
            const el = root.querySelector('[data-kingdom-stat="' + statKey + '"]');
            if (el) {
                el.textContent = text
            }
        }
        if (typeof kingdom.owner_name === 'string') {
            updateText('owner_name', kingdom.owner_name)
        }
        updateText('faith', formatInt(kingdom.faith) + '%');
        updateText('census', formatInt(kingdom.census));
        updateText('grain', formatInt(kingdom.grain));
        updateText('ambrosia', formatInt(kingdom.ambrosia));
        updateText('coffers', formatInt(kingdom.coffers) + 'g');
        updateText('footmen', formatInt(kingdom.footmen));
        updateText('longbowmen', formatInt(kingdom.longbowmen));
        updateText('ballistae', formatInt(kingdom.ballistae));
        updateText('trebuchets', formatInt(kingdom.trebuchets));
        updateText('keep_n', formatInt(kingdom.keep_n_lvl));
        updateText('keep_s', formatInt(kingdom.keep_s_lvl));
        updateText('keep_e', formatInt(kingdom.keep_e_lvl));
        updateText('keep_w', formatInt(kingdom.keep_w_lvl));
        updateText('curtain_n', formatInt(kingdom.curtain_n_lvl));
        updateText('curtain_s', formatInt(kingdom.curtain_s_lvl));
        updateText('curtain_e', formatInt(kingdom.curtain_e_lvl));
        updateText('curtain_w', formatInt(kingdom.curtain_w_lvl));
        updateText('castle_n', formatInt(kingdom.castle_n_lvl));
        updateText('castle_s', formatInt(kingdom.castle_s_lvl));
        updateText('castle_e', formatInt(kingdom.castle_e_lvl));
        updateText('castle_w', formatInt(kingdom.castle_w_lvl));
        const keepTotal = kingdom.keep_n_lvl + kingdom.keep_s_lvl + kingdom.keep_e_lvl + kingdom.keep_w_lvl;
        const curtainTotal = kingdom.curtain_n_lvl + kingdom.curtain_s_lvl + kingdom.curtain_e_lvl + kingdom.curtain_w_lvl;
        const castleTotal = kingdom.castle_n_lvl + kingdom.castle_s_lvl + kingdom.castle_e_lvl + kingdom.castle_w_lvl;
        updateText('keep_total', formatInt(keepTotal));
        updateText('curtain_total', formatInt(curtainTotal));
        updateText('castle_total', formatInt(castleTotal))
    }

    function applyWarBuffs(snapshot, meta) {
        const root = getPanel();
        if (!root) {
            return
        }
        const serverNow = Number(meta && meta.server_time_ms || 0);
        const attackUntil = Number(snapshot && snapshot.war_attack_until_ms || meta && meta.war_attack_until_ms || 0);
        const defenseUntil = Number(snapshot && snapshot.war_defense_until_ms || meta && meta.war_defense_until_ms || 0);

        function formatRemaining(untilMs) {
            if (!serverNow || !untilMs || untilMs <= serverNow) {
                return 'None'
            }
            const remainingMs = Math.max(0, untilMs - serverNow);
            const totalSeconds = Math.ceil(remainingMs / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const padded = seconds < 10 ? '0' + String(seconds) : String(seconds);
            return '+15% (' + String(minutes) + ':' + padded + ')'
        }
        const atkEl = root.querySelector('[data-kingdom-stat="war_attack_buff"]');
        if (atkEl) {
            const label = formatRemaining(attackUntil);
            const active = label !== 'None';
            atkEl.textContent = label;
            atkEl.classList.toggle('text-gray-400', !active);
            atkEl.classList.toggle('text-orange-300', active);
            atkEl.classList.toggle('font-semibold', active)
        }
        const defEl = root.querySelector('[data-kingdom-stat="war_defense_buff"]');
        if (defEl) {
            const label = formatRemaining(defenseUntil);
            const active = label !== 'None';
            defEl.textContent = label;
            defEl.classList.toggle('text-gray-400', !active);
            defEl.classList.toggle('text-sky-300', active);
            defEl.classList.toggle('font-semibold', active)
        }
    }

    function stopPolling() {
        if (pollTimer) {
            clearInterval(pollTimer);
            pollTimer = null;
            currentInterval = 0
        }
    }

    function schedulePolling(intervalMs) {
        const effectiveInterval = visibilityIntervalOverride > 0 ? visibilityIntervalOverride : intervalMs;
        if (effectiveInterval <= 0) {
            stopPolling();
            return
        }
        if (pollTimer && currentInterval === effectiveInterval) {
            return
        }
        if (pollTimer) {
            clearInterval(pollTimer);
            pollTimer = null
        }
        currentInterval = effectiveInterval;
        pollTimer = setInterval(pollOnce, effectiveInterval)
    }

    function updateActionBarVisibility() {
        const panel = getPanel();
        if (!panel) {
            return
        }
        const modeSelect = panel.querySelector('select[name="kingdom_action_mode"]');
        if (!modeSelect) {
            return
        }
        const mode = String(modeSelect.value || '').toLowerCase();
        const unitField = panel.querySelector('[data-kingdom-field="unit"]');
        const dirField = panel.querySelector('[data-kingdom-field="direction"]');
        const structField = panel.querySelector('[data-kingdom-field="structure"]');
        const amountField = panel.querySelector('[data-kingdom-field="amount"]');
        const amountInput = amountField ? amountField.querySelector('input[name="kingdom_amount"]') : null;

        function setVisible(el, show) {
            if (!el) return;
            el.style.display = show ? '' : 'none'
        }
        const usesUnit = mode === 'build_army';
        const usesDirStruct = mode === 'fortify';
        const usesAmount = mode === 'build_army' || mode === 'fortify' || mode === 'buy_grain' || mode === 'deposit' || mode === 'withdraw' || mode === 'levy' || mode === 'ambrosia' || mode === 'ambrosia_withdraw' || mode === 'compensate';
        setVisible(unitField, usesUnit);
        setVisible(dirField, usesDirStruct);
        setVisible(structField, usesDirStruct);
        setVisible(amountField, usesAmount);
        if (amountInput) {
            if (mode === 'compensate') {
                amountInput.max = '100';
                amountInput.placeholder = 'Faith to add'
            } else {
                amountInput.removeAttribute('max');
                amountInput.removeAttribute('placeholder')
            }
        }
    }

    function bindActionBar() {
        const panel = getPanel();
        if (!panel) {
            return
        }
        const modeSelect = panel.querySelector('select[name="kingdom_action_mode"]');
        if (!modeSelect) {
            return
        }
        if (!modeSelect.dataset.kingdomActionBound) {
            modeSelect.addEventListener('change', updateActionBarVisibility);
            modeSelect.dataset.kingdomActionBound = '1'
        }
        updateActionBarVisibility()
    }

    function pollOnce() {
        const panel = getPanel();
        if (!panel) {
            stopPolling();
            return
        }
        fetch('api/kingdom_status.php', {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
            },
        }).then((response) => {
            if (!response.ok) {
                throw new Error('Bad response')
            }
            return response.json()
        }).then((data) => {
            if (!data || !data.ok) {
                return
            }
            const kingdom = data.kingdom || null;
            applySnapshot(kingdom);
            applyWarBuffs(kingdom, data);
            const serverNow = Number(data.server_time_ms || 0);
            const underUntil = kingdom ? Number(kingdom.under_attack_until_ms || 0) : 0;
            const isUnderAttack = kingdom && serverNow > 0 && underUntil > serverNow;
            const desiredInterval = isUnderAttack ? FAST_INTERVAL_MS : SLOW_INTERVAL_MS;
            schedulePolling(desiredInterval)
        }).catch(() => {
            schedulePolling(SLOW_INTERVAL_MS)
        })
    }
    document.addEventListener('DOMContentLoaded', function bootstrapKingdomPolling() {
        const panel = getPanel();
        if (!panel) {
            return
        }
        bindActionBar();
        pollOnce();
        schedulePolling(SLOW_INTERVAL_MS)
    });

    function handleVisibilityChange() {
        if (!isPageVisible()) {
            visibilityIntervalOverride = HIDDEN_INTERVAL_MS;
            pollingSuspended = !1;
            schedulePolling(HIDDEN_INTERVAL_MS);
            return
        }
        visibilityIntervalOverride = 0;
        if (pollingSuspended) {
            pollingSuspended = !1
        }
        pollOnce();
        schedulePolling(SLOW_INTERVAL_MS)
    }
    if (typeof document.visibilityState !== 'undefined') {
        document.addEventListener('visibilitychange', handleVisibilityChange)
    }
    handleVisibilityChange();
    window.Kingdoms = window.Kingdoms || {};
    window.Kingdoms.refreshFromMapMove = function refreshFromMapMove() {
        const panel = getPanel();
        if (!panel) {
            return
        }
        pollOnce()
    };
    window.Kingdoms.rebindActionBar = function rebindActionBar() {
        bindActionBar()
    }
})()