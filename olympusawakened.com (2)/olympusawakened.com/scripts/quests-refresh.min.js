'use strict';(function initQuestRefresh(){if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',setupQuestRefresh)}else{setupQuestRefresh()}})();function setupQuestRefresh(){window.QuestRefresh=window.QuestRefresh||{};window.QuestRefresh.refreshAvailable=refreshAvailableQuests;window.QuestRefresh.refreshActive=refreshActiveQuests}
function refreshAvailableQuests(){const panel=document.querySelector('[data-quests-available-panel]');if(!panel){return}
fetch('api/quests_available.php',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8',},body:new URLSearchParams({csrf_token:window.csrfToken||'',}),}).then((response)=>{if(!response.ok){throw new Error('Failed to refresh quests')}
return response.json()}).then((data)=>{renderAvailableQuestsPanel(panel,data&&data.quests?data.quests:[])}).catch(()=>{})}
function refreshActiveQuests(){const panel=document.querySelector('[data-quests-active-panel]');if(!panel){return}
fetch('api/quests_active.php',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8',},body:new URLSearchParams({csrf_token:window.csrfToken||'',}),}).then((response)=>{if(!response.ok){throw new Error('Failed to refresh active quests')}
return response.json()}).then((data)=>{renderActiveQuestsPanel(panel,data&&data.quests?data.quests:[])}).catch(()=>{})}
function renderAvailableQuestsPanel(panel,quests){panel.innerHTML='';if(!Array.isArray(quests)||quests.length===0){const emptyEl=document.createElement('div');emptyEl.className='text-gray-400';emptyEl.textContent='No quests available at this location.';panel.appendChild(emptyEl);return}
quests.forEach((quest)=>{const typeText=String(quest.type||'');const card=document.createElement('div');card.className='border border-gray-700 rounded-md p-3 bg-gray-900';const contentRow=document.createElement('div');contentRow.className='flex items-start gap-3';const imgWrap=document.createElement('div');imgWrap.className='flex-shrink-0';const img=document.createElement('img');const rawIcon=typeof quest.icon==='string'?quest.icon.trim():'';let iconPath=(window.questItemPlaceholderSrc&&String(window.questItemPlaceholderSrc))||'assets/img/ui/quest_item_placeholder.jpg';if(rawIcon){let file=rawIcon.replace(/^\/+/,'');if(file.toLowerCase().startsWith('assets/img/ui/')){file=file.slice('assets/img/ui/'.length)}
iconPath='assets/img/ui/'+file}
img.src=iconPath;img.alt=String(quest.title||'Quest');img.className='w-12 h-12 object-contain rounded';imgWrap.appendChild(img);contentRow.appendChild(imgWrap);const textWrap=document.createElement('div');textWrap.className='flex-1';const title=document.createElement('div');title.className='font-semibold text-gray-100 mb-1';title.textContent=String(quest.title||'Quest');const desc=document.createElement('div');desc.className='text-gray-300 mb-2 whitespace-pre-line';desc.textContent=String(quest.description||'');const meta=document.createElement('div');meta.className='text-xs text-gray-400 mb-2';const minLevel=Number.isFinite(quest.min_level)?quest.min_level:'';meta.textContent=`Type: ${typeText} â€¢ Min Level: ${minLevel}`;const form=document.createElement('form');form.method='post';const csrfInput=document.createElement('input');csrfInput.type='hidden';csrfInput.name='csrf_token';csrfInput.value=window.csrfToken||'';const actionInput=document.createElement('input');actionInput.type='hidden';actionInput.name='action';actionInput.value='accept_quest';const idInput=document.createElement('input');idInput.type='hidden';idInput.name='quest_id';idInput.value=String(quest.id||'');const button=document.createElement('button');button.type='submit';button.className='px-3 py-1.5 rounded-md bg-purple-600 hover:bg-purple-500 text-xs font-semibold text-white';button.textContent='Accept Quest';form.appendChild(csrfInput);form.appendChild(actionInput);form.appendChild(idInput);form.appendChild(button);textWrap.appendChild(title);textWrap.appendChild(desc);textWrap.appendChild(meta);textWrap.appendChild(form);contentRow.appendChild(textWrap);card.appendChild(contentRow);panel.appendChild(card)})}
function renderActiveQuestsPanel(panel,quests){panel.innerHTML='';if(!Array.isArray(quests)||quests.length===0){const emptyEl=document.createElement('div');emptyEl.className='text-gray-400';emptyEl.textContent='You have no active quests.';panel.appendChild(emptyEl);return}
quests.forEach((quest)=>{const typeText=String(quest.type||'');const card=document.createElement('div');card.className='border border-gray-700 rounded-md p-3 bg-gray-900';const header=document.createElement('div');header.className='flex items-center justify-between mb-1';const leftWrap=document.createElement('div');leftWrap.className='flex items-center gap-2';const img=document.createElement('img');const rawIcon=typeof quest.icon==='string'?quest.icon.trim():'';let iconPath=(window.questItemPlaceholderSrc&&String(window.questItemPlaceholderSrc))||'assets/img/ui/quest_item_placeholder.jpg';if(rawIcon){let file=rawIcon.replace(/^\/+/,'');if(file.toLowerCase().startsWith('assets/img/ui/')){file=file.slice('assets/img/ui/'.length)}
iconPath='assets/img/ui/'+file}
img.src=iconPath;img.alt=String(quest.title||'Quest');img.className='w-8 h-8 object-contain rounded';leftWrap.appendChild(img);const title=document.createElement('div');title.className='font-semibold text-gray-100';title.textContent=String(quest.title||'Quest');const badgeWrap=document.createElement('div');badgeWrap.className='text-xs';const badge=document.createElement('span');const status=String(quest.status||'');const isCompleted=status==='completed';badge.className='px-2 py-0.5 rounded-full text-xs font-semibold '+(isCompleted?'bg-green-700 text-green-200':'bg-blue-700 text-blue-100');badge.textContent=isCompleted?'Completed':'In Progress';badgeWrap.appendChild(badge);leftWrap.appendChild(title);header.appendChild(leftWrap);header.appendChild(badgeWrap);const desc=document.createElement('div');desc.className='text-gray-300 mb-2 whitespace-pre-line';desc.textContent=String(quest.description||'');card.appendChild(header);card.appendChild(desc);const required=Number.isFinite(quest.required_amount)?quest.required_amount:0;const progress=Number.isFinite(quest.progress_amount)?quest.progress_amount:0;if(required>0){const prog=document.createElement('div');prog.className='text-xs text-gray-400 mb-2';prog.textContent=`Progress: ${progress} / ${required}`;card.appendChild(prog)}
if(isCompleted&&quest.quest_id){const form=document.createElement('form');form.method='post';form.className='mt-2';const csrfInput=document.createElement('input');csrfInput.type='hidden';csrfInput.name='csrf_token';csrfInput.value=window.csrfToken||'';const actionInput=document.createElement('input');actionInput.type='hidden';actionInput.name='action';actionInput.value='turn_in_quest';const idInput=document.createElement('input');idInput.type='hidden';idInput.name='quest_id';idInput.value=String(quest.quest_id);const button=document.createElement('button');button.type='submit';button.className='px-3 py-1.5 rounded-md bg-purple-600 hover:bg-purple-500 text-xs font-semibold text-white';button.textContent='Turn In';form.appendChild(csrfInput);form.appendChild(actionInput);form.appendChild(idInput);form.appendChild(button);card.appendChild(form)}
panel.appendChild(card)})}