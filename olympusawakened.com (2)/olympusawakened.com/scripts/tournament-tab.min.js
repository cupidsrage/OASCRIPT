'use strict';

(function initTournamentTabWatcher() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupTournamentTabWatcher);
  } else {
    setupTournamentTabWatcher();
  }
})();

function setupTournamentTabWatcher() {
  // Only applies on the main game shell.
  const activeTabLink = document.querySelector(
    'a[data-active-tab="1"][data-tab-id]',
  );
  if (!activeTabLink) {
    return;
  }

  const POLL_INTERVAL_MS = 10000;
  const HIDDEN_POLL_INTERVAL_MS = 30000;
  let pollTimer = null;
  let pollIntervalMs = 0;

  function findTabsContainer() {
    const activeLink = document.querySelector(
      'a[data-active-tab="1"][data-tab-id]',
    );
    return activeLink ? activeLink.parentElement : null;
  }

  function findTournamentTab(container) {
    if (!container) {
      return null;
    }
    const links = container.querySelectorAll('a[href]');
    for (let i = 0; i < links.length; i += 1) {
      const link = links[i];
      const href = (link.getAttribute('href') || '').toLowerCase();
      const text = (link.textContent || '').trim().toLowerCase();
      if (
        href.indexOf('game.php?tab=tournament') !== -1 ||
        text === 'tournament'
      ) {
        return link;
      }
    }
    return null;
  }

  function applyTournamentTabPayload(data) {
    if (!data || !data.success || !data.tab_enabled) {
      return;
    }
    const container = findTabsContainer();
    if (!container) {
      return;
    }
    const existing = findTournamentTab(container);
    if (existing) {
      return;
    }
    const link = document.createElement('a');
    link.href = 'game.php?tab=tournament';
    link.textContent = 'Tournament';
    link.className =
      'px-3 py-1.5 text-xs sm:px-4 sm:py-2 sm:text-sm rounded-lg font-semibold transition-all bg-gray-700 hover:bg-gray-600';
    container.appendChild(link);
  }

  function ensureTournamentTabVisible() {
    fetch('api/tournament_status.php', { credentials: 'same-origin' })
      .then((res) => {
        if (!res.ok) {
          throw new Error('tournament tab status failed');
        }
        return res.json();
      })
      .then((data) => {
        applyTournamentTabPayload(data);
      })
      .catch(() => {
        // swallow polling failures; user can refresh.
      });
  }

  function startPolling(intervalMs) {
    const nextInterval = intervalMs > 0 ? intervalMs : POLL_INTERVAL_MS;
    if (pollTimer && pollIntervalMs === nextInterval) {
      return;
    }
    if (pollTimer) {
      window.clearInterval(pollTimer);
      pollTimer = null;
    }
    pollIntervalMs = nextInterval;
    ensureTournamentTabVisible();
    pollTimer = window.setInterval(ensureTournamentTabVisible, pollIntervalMs);
  }

  function stopPolling() {
    if (!pollTimer) {
      return;
    }
    window.clearInterval(pollTimer);
    pollTimer = null;
  }

  function handleVisibilityChange() {
    if (document.visibilityState === 'hidden') {
      startPolling(HIDDEN_POLL_INTERVAL_MS);
      return;
    }
    startPolling(POLL_INTERVAL_MS);
  }

  const sharedPolling = window.TournamentStatusPolling;
  if (sharedPolling && typeof sharedPolling.subscribe === 'function') {
    sharedPolling.subscribe('tournament_tab_watcher', {
      visibleIntervalMs: POLL_INTERVAL_MS,
      hiddenIntervalMs: HIDDEN_POLL_INTERVAL_MS,
      onData: (data) => {
        applyTournamentTabPayload(data);
      },
      onError: () => {
        // swallow polling failures; user can refresh.
      },
    });
    return;
  }

  // Fallback: legacy standalone polling if shared poll manager is unavailable.
  if (typeof document.visibilityState !== 'undefined') {
    document.addEventListener('visibilitychange', handleVisibilityChange);
  }
  handleVisibilityChange();
}
