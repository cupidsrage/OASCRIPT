'use strict';

(function initTournamentLock() {
  var config = document.getElementById('tournament-lock-config');
  if (!config) {
    return;
  }

  var isStaff = config.getAttribute('data-is-staff') === '1';
  if (isStaff) {
    return;
  }

  var statusUrl = config.getAttribute('data-tournament-status') || 'api/tournament_status.php';
  var redirectUrl = config.getAttribute('data-tournament-redirect') || 'game.php?tab=tournament';
  var pollMs = parseInt(config.getAttribute('data-tournament-poll') || '8000', 10);
  if (!Number.isFinite(pollMs) || pollMs < 3000) {
    pollMs = 8000;
  }

  var isRedirecting = false;

  function getOrCreateTournamentStatusPolling(url) {
    if (
      window.TournamentStatusPolling
      && typeof window.TournamentStatusPolling.subscribe === 'function'
      && window.TournamentStatusPolling.url === url
    ) {
      return window.TournamentStatusPolling;
    }

    var subscribers = {};
    var timerId = null;
    var activeIntervalMs = 0;
    var inFlight = null;
    var lastPayload = null;
    var visibilityBound = false;

    function isPageVisible() {
      return typeof document.visibilityState === 'undefined'
        || document.visibilityState !== 'hidden';
    }

    function normalizeInterval(value) {
      var n = Number(value);
      if (!Number.isFinite(n) || n <= 0) {
        return 0;
      }
      return Math.floor(n);
    }

    function forEachSubscriber(handler) {
      Object.keys(subscribers).forEach(function (id) {
        var sub = subscribers[id];
        if (!sub) {
          return;
        }
        handler(sub, id);
      });
    }

    function getTargetIntervalMs() {
      var best = 0;
      var visible = isPageVisible();
      forEachSubscriber(function (sub) {
        var candidate = visible ? sub.visibleIntervalMs : sub.hiddenIntervalMs;
        if (candidate <= 0) {
          return;
        }
        if (best <= 0 || candidate < best) {
          best = candidate;
        }
      });
      return best;
    }

    function notifyData(payload) {
      forEachSubscriber(function (sub) {
        if (typeof sub.onData !== 'function') {
          return;
        }
        try {
          sub.onData(payload);
        } catch (e) {
          // Swallow subscriber handler errors.
        }
      });
    }

    function notifyError(error) {
      forEachSubscriber(function (sub) {
        if (typeof sub.onError !== 'function') {
          return;
        }
        try {
          sub.onError(error);
        } catch (e) {
          // Swallow subscriber handler errors.
        }
      });
    }

    function requestNow() {
      if (inFlight) {
        return inFlight;
      }
      inFlight = fetch(url, { credentials: 'same-origin' })
        .then(function (res) {
          if (!res.ok) {
            throw new Error('tournament status failed');
          }
          return res.json();
        })
        .then(function (payload) {
          lastPayload = payload;
          notifyData(payload);
          return payload;
        })
        .catch(function (error) {
          notifyError(error);
          throw error;
        })
        .finally(function () {
          inFlight = null;
        });
      return inFlight;
    }

    function ensureVisibilityBinding() {
      if (visibilityBound || typeof document.visibilityState === 'undefined') {
        return;
      }
      visibilityBound = true;
      document.addEventListener('visibilitychange', function () {
        schedule();
      });
    }

    function stopTimer() {
      if (!timerId) {
        return;
      }
      window.clearInterval(timerId);
      timerId = null;
      activeIntervalMs = 0;
    }

    function schedule() {
      ensureVisibilityBinding();
      var nextIntervalMs = getTargetIntervalMs();
      if (nextIntervalMs <= 0) {
        stopTimer();
        return;
      }
      if (timerId && activeIntervalMs === nextIntervalMs) {
        return;
      }
      stopTimer();
      activeIntervalMs = nextIntervalMs;
      requestNow().catch(function () {
        // Subscriber-specific handlers already ran.
      });
      timerId = window.setInterval(function () {
        requestNow().catch(function () {
          // Subscriber-specific handlers already ran.
        });
      }, activeIntervalMs);
    }

    window.TournamentStatusPolling = {
      url: url,
      subscribe: function subscribe(id, options) {
        if (!id) {
          return function noop() {};
        }
        var opts = options || {};
        var visibleIntervalMs = normalizeInterval(opts.visibleIntervalMs);
        var hiddenIntervalMs = normalizeInterval(opts.hiddenIntervalMs || visibleIntervalMs);
        subscribers[id] = {
          visibleIntervalMs: visibleIntervalMs,
          hiddenIntervalMs: hiddenIntervalMs,
          onData: typeof opts.onData === 'function' ? opts.onData : null,
          onError: typeof opts.onError === 'function' ? opts.onError : null,
        };
        if (lastPayload && typeof subscribers[id].onData === 'function') {
          try {
            subscribers[id].onData(lastPayload);
          } catch (e) {
            // Swallow subscriber handler errors.
          }
        }
        schedule();
        return function unsubscribe() {
          delete subscribers[id];
          schedule();
        };
      },
      refreshNow: function refreshNow() {
        return requestNow();
      },
    };

    return window.TournamentStatusPolling;
  }

  function isOnTournamentTab() {
    try {
      var current = new URL(window.location.href);
      var target = new URL(redirectUrl, window.location.origin);
      if (current.pathname !== target.pathname) {
        return false;
      }
      return current.searchParams.get('tab') === 'tournament';
    } catch (e) {
      return window.location.href.indexOf(redirectUrl) !== -1;
    }
  }

  function shouldRedirect(data) {
    if (!data || !data.success) {
      return false;
    }
    if (!data.tournament_running) {
      return false;
    }
    return !isOnTournamentTab();
  }

  function setTabLock(isLocked) {
    var tabs = document.querySelectorAll('[data-tab-lockable="1"]');
    if (!tabs.length) {
      return;
    }
    tabs.forEach(function (tab) {
      if (isLocked) {
        if (tab.getAttribute('data-locked') === '1') {
          return;
        }
        tab.classList.add('opacity-50', 'pointer-events-none');
        tab.setAttribute('aria-disabled', 'true');
        tab.setAttribute('tabindex', '-1');
        tab.setAttribute('data-locked', '1');
      } else if (tab.getAttribute('data-locked') === '1') {
        tab.classList.remove('opacity-50', 'pointer-events-none');
        tab.removeAttribute('aria-disabled');
        tab.removeAttribute('tabindex');
        tab.removeAttribute('data-locked');
      }
      });
  }

  var polling = getOrCreateTournamentStatusPolling(statusUrl);
  if (!polling || typeof polling.subscribe !== 'function') {
    return;
  }

  polling.subscribe('tournament_lock', {
    visibleIntervalMs: pollMs,
    hiddenIntervalMs: pollMs,
    onData: function onData(data) {
      if (isRedirecting) {
        return;
      }
      var running = !!(data && data.tournament_running);
      setTabLock(running);
      if (shouldRedirect(data)) {
        isRedirecting = true;
        window.location.href = redirectUrl;
      }
    },
    onError: function onError() {
      // Ignore polling failures.
    },
  });
})();
